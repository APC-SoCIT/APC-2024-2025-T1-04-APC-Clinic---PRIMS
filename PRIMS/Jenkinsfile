pipeline {
    agent {
        docker {
            image 'php-node-composer'  // the image we built
            args '-u root:root'        // optional: run as root
        }
    }

    environment {
        DB_CONNECTION = 'mysql'
        DB_HOST = 'mysql_host'
        DB_PORT = '3306'
        DB_DATABASE = 'laravel_db'
        DB_USERNAME = 'root'
        DB_PASSWORD = 'password'
    }

    stages {
        stage('Checkout') {
            steps {
                git 'https://github.com/your-org/your-laravel-project.git'
            }
        }

        stage('Install PHP dependencies') {
            steps {
                sh 'composer install'
            }
        }

        stage('Install Node dependencies') {
            steps {
                sh 'npm install'
                sh 'npm run build'  // or 'yarn build'
            }
        }

        stage('Run Tests') {
            steps {
                sh 'php artisan test'
            }
        }
    }
}
