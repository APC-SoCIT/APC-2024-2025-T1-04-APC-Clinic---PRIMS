pipeline {
    agent any

    stages {
        stage('Build') {
            steps {
                sh '''#!/bin/bash
                set -euxo pipefail
                cd PRIMS
                composer install
                ./vendor/bin/sail build
                '''
            }
        }

        stage('Unit Test') {
            steps {
                sh '''#!/bin/bash
                set -euxo pipefail
                cd PRIMS
                ./vendor/bin/sail artisan test
                '''
            }
        }

        stage('Deploy To Test Env') {
            steps {
                sh '''#!/bin/bash
                set -euxo pipefail
                cd PRIMS
                docker compose up -d
                '''
            }
        }

        stage('Integration Test') {
            steps {
                sh '''#!/bin/bash
                set -euxo pipefail
                cd PRIMS
                ./vendor/bin/sail artisan test --testsuite=Feature
                '''
            }
        }

        stage('Create Docker Image') {
            steps {
                sh '''#!/bin/bash
                set -euxo pipefail
                cd PRIMS
                docker build -t prims-app .
                '''
            }
        }
    }

    post {
        always {
            sh '''#!/bin/bash
            set +e
            cd PRIMS
            docker compose ps || true
            docker compose logs --no-color laravel.test | tail -n 200 || true
            docker compose down -v || true
            '''
        }
    }
}
