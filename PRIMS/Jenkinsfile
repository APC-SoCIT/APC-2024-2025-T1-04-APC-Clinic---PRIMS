pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "wonderpets-prims:${env.BUILD_NUMBER}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Sail') {
            steps {
                dir('PRIMS') {
                    echo "Installing Laravel Sail..."
                    sh 'composer require laravel/sail --dev'
                }
            }
        }

        stage('Build') {
            steps {
                dir('PRIMS') {
                    echo "Installing PHP & Node dependencies..."
                    sh './vendor/bin/sail composer install --no-interaction --prefer-dist'
                    sh './vendor/bin/sail npm install'
                    sh './vendor/bin/sail npm audit fix'
                    sh './vendor/bin/sail npm run build'
                }
            }
        }

        stage('Run Unit Tests') {
            steps {
                dir('PRIMS') {
                    sh './vendor/bin/sail artisan test --env=testing'
                }
            }
        }

        stage('Deploy to Test Env') {
            steps {
                dir('PRIMS') {
                    sh './vendor/bin/sail up -d'
                }
            }
        }

        stage('Integration Test') {
            steps {
                dir('PRIMS') {
                    sh 'curl -f http://localhost || exit 1'
                }
            }
        }

        stage('Create Docker Image') {
            steps {
                dir('PRIMS') {
                    sh "docker build -t ${DOCKER_IMAGE} ."
                }
            }
        }

        stage('Commit Jenkinsfile') {
            steps {
                sh '''
                git config user.email "jmmiyabe@student.apc.edu.ph"
                git config user.name "jmmiyabe"
                git add Jenkinsfile
                git commit -m "Add Jenkinsfile" || true
                git push origin HEAD:main
                '''
            }
        }
    }

    post {
        always {
            dir('PRIMS') {
                sh './vendor/bin/sail down || true'
            }
        }
    }
}
