pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "wonderpets-prims:${env.BUILD_NUMBER}"
    }

    stages {
        stage('Build') {
            steps {
                echo "Installing PHP & Node dependencies..."
                sh '''
                    # sail installation
                    docker run --rm -u "$(id -u):$(id -g)" \
                        -v $(pwd):/var/www/html \
                        -w /var/www/html \
                        laravelsail/php82-composer:latest composer require laravel/sail --dev

                    # install dependencies
                    docker run --rm -u "$(id -u):$(id -g)" \
                        -v $(pwd):/var/www/html \
                        -w /var/www/html \
                        laravelsail/php82-composer:latest composer install --no-interaction --prefer-dist --optimize-autoloader

                    ./vendor/bin/sail npm ci
                    ./vendor/bin/sail npm run build
                '''
            }
        }

        stage('Unit Test') {
            steps {
                echo "Running Unit Tests..."
                sh './vendor/bin/sail artisan test --testsuite=Unit'
            }
        }

        stage('Deploy to Test Env') {
            steps {
                echo "Starting Sail environment..."
                sh '''
                    ./vendor/bin/sail up -d
                    ./vendor/bin/sail artisan migrate:fresh --seed
                '''
            }
        }

        stage('Integration Test') {
            steps {
                echo "Running Integration Tests..."
                sh './vendor/bin/sail artisan test --testsuite=Feature'
            }
        }

        stage('Create Docker Image') {
            steps {
                echo "Building Docker Image..."
                sh "docker build -t $DOCKER_IMAGE ."
            }
        }
    }

    post {
        always {
            echo "Cleaning up Sail containers..."
            sh './vendor/bin/sail down || true'
        }
    }
}
